#!/usr/bin/env bash

if [ `uname -s` == "Darwin" ]; then
    libSuffix="dylib"
    lddTool="otool -L"
    debugger="/usr/local/opt/llvm/bin/lldb"
    args="--"
else
    libSuffix="so"
    lddTool="ldd"
    debugger="lldb"
    args="--"
fi

if [ $# -lt 1 ]; then
    echo "Usage: $0 build-directory [chibi-args...]"
    exit 1
fi

builddir=$1

if [ $(${lddTool} "${builddir}/lib/libsym2.${libSuffix}" | grep -iqs 'lib.*asan' &>/dev/null) ]; then
    echo "libsym2 is linked against the ASAN runtime. Debugging works better without sanitizers."
    exit 1
fi

chibi="${builddir}/scheme/bin/chibi-scheme"
chibilibs="${builddir}/scheme/lib"
paths="-I ${chibilibs} -I ${builddir}/lib -I src"

shift 1

export LD_LIBRARY_PATH="${chibilibs}"

${debugger} "${chibi}" "${args}" -i "${builddir}/scheme/share/chibi/chibi.img" ${paths} -m sym2 $@
