#!/usr/bin/env bash

if [ `uname -s` == "Darwin" ]; then
    libSuffix="dylib"
    lddTool="otool -L"
    preload="DYLD_INSERT_LIBRARIES"
else
    libSuffix="so"
    lddTool="ldd"
    preload="LD_PRELOAD"
fi

libraries=`ls -1t build*/src/sym2chibi.${libSuffix} 2>/dev/null`

if [ -z "${libraries}" ]; then
    echo "No chibi-scheme bindings found"
    exit 1
fi

latest=`echo "${libraries}" | sed '1q'`
builddir=`echo "${latest}" | cut -d'/' -f1`
chibi="${builddir}/lib/chibi-scheme/chibi-scheme"
libsym2="${builddir}/src/libsym2.${libSuffix}"
libasan=`${lddTool} "${libsym2}" | grep 'lib.*asan' | awk '{ print $1 }'`

chibilibs="lib/chibi-scheme/lib"
paths="-I ${chibilibs} -I ${builddir}/${chibilibs} -I ${builddir}/src -I src"

export "${preload}=${libasan}"

echo "Running chibi-scheme from ${builddir}..."

${chibi} -i "${builddir}/lib/chibi-scheme/chibi.img" ${paths} -m sym2 $@
